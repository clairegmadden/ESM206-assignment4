---
title: "ESM206-assignment4"
author: "Claire Madden, Bridget Gibbons, Andrew Paterson"
date: "11/12/2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE}

library(tidyverse)
library(vcdExtra)
library(RColorBrewer)
library(dplyr)
library(car)
library(effsize)
library(kableExtra)

```

```{r, echo=FALSE, message=FALSE}

lobster_size <- read_csv("lobster_size_abundance.csv")
lobster_traps <- read_csv("lobster_traps.csv")

```


```{r}

lobster_size2 <- as.data.frame(lobster_size)
lobster_size_tidy <- expand.dft(lobster_size2, freq = "COUNT")

#If you guys don't want to change the site name here, no problem!
size_tidy <- lobster_size_tidy %>% 
  mutate(Site=
    case_when(
      SITE == "NAPL" ~ "Naples Reef",
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "CARP" ~ "Carpinteria"
    )
  ) %>% 
  select(-SITE)

traps_tidy <- lobster_traps %>% 
    mutate(Site=
    case_when(
      SITE == "NAPL" ~ "Naples Reef",
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "CARP" ~ "Carpinteria"
    )
  ) %>% 
  select(-SITE)


```

#Part 1 (Claire)
```{r}

abundance_summary <- lobster_size %>%
  group_by(SITE, YEAR) %>% 
  summarize(
    count = sum(COUNT))

abundance_column <- ggplot(abundance_summary, aes( x = YEAR, y = count))+
  geom_col()+
  facet_wrap(~SITE)

abundance_column


traps_simple <- lobster_traps %>% 
  filter(SITE == "AQUE" | SITE == "NAPL" | SITE == "MOHK" | SITE == "IVEE" | SITE == "CARP")

traps_summary <- traps_simple %>% 
  group_by(SITE, YEAR) %>% 
  summarize(
    traps = sum(TRAPS))

traps_column <- ggplot(traps_summary, aes( x = YEAR, y = traps))+
  geom_col()+
  facet_wrap(~SITE)

traps_column


abundance_scatter <- ggplot(abundance_summary, aes(x = YEAR, y = count))+
  geom_point()+
  geom_line()+
  facet_wrap(~SITE)

abundance_scatter

traps_scatter <- ggplot(traps_summary, aes(x = YEAR, y = traps))+
  geom_point()+
  geom_line()+
  facet_wrap(~SITE)

traps_scatter

```

```{r}
# my attempt at joining the data before graphing and or getting both graphs for one location on the same plane

abundance_traps <- full_join(abundance_summary, traps_summary)


both_scatter <- ggplot(abundance_traps, aes(x = YEAR))+
  geom_line(aes(y=count, color = "blue"))+
  geom_line(aes(y=traps, color = "red"))+
  facet_wrap(~SITE)+
  theme_light()

both_scatter




```


#Part 2 (Andrew)

```{r}

#Filter for just 2017 results for Part 2, and Exploratory Histogram and QQ Plots

size_2017 <- size_tidy %>% 
  filter(YEAR == "2017") %>%
  select(SIZE, Site)

carapace_hist <- ggplot(size_2017, aes(x = SIZE))+
  geom_histogram(bins = 23, aes(fill = Site))+
  facet_wrap(~Site)

carapace_hist

carapace_qq <- ggplot(size_2017, aes(sample = SIZE))+
  geom_qq()+
  facet_wrap(~Site)

carapace_qq

#The data looks roughly normally distributed, and all sites have a sample size of greater than 30. 

```

```{r}

#Levene's Test for Equal Variances, since we have more than two groups
#H0: Variances are equal
#HA: Variances are not equal

carapace_levene <- leveneTest(SIZE ~ Site, data = size_2017)
carapace_levene

#We reject the null hypothesis of equal variances (p < .001) based on Levene's Test.  However, we can examine the variances of each site to see if the largest is less than four times the smallest variance.  

carapace_variances <- size_2017 %>% 
  group_by(Site) %>% 
  summarize(
    Variance = var(SIZE)
  )

carapace_variances

#The largest variance is well less than four times the smallest variance, so we can assume accept the null hypothesis of equal variances and run an ANOVA.

#H0: Mean carapace sizes are equal at all sites
#HA: Mean carapace sizes vary for lobsters from at least two sites.

carapace_aov <- aov(SIZE ~ Site, data = size_2017)
summary(carapace_aov)

#boxplot for ANOVA in case we want to include this
lobster_anova <- ggplot(size_2017, aes(x = Site, y = SIZE))+
  geom_boxplot()+
  scale_x_discrete()+
  scale_y_discrete()+
  ylab("Size")+
  xlab("Site")

lobster_anova

#With p = .0085, we reject the null, and assume mean carapace length varies between lobsters from at least two sites. At least two populations were taken from populations with different means.

#Post-hoc testing using Tukey's HSD

carapace_ph <- TukeyHSD(carapace_aov)
carapace_ph

#Lobster sizes differed significantly only between Naples Reef and Carpenteria, and Naples Reef and Isla Vista. Do we want to run Cohen's d here?  It might get very clunky to convey all of the effect sizes, or maybe we could make a table showing all of the differences and effect sizes?

```

**Figure 1: Mean Lobster Carapace Length at Five LTER Sites in the Santa Barbara Channel** 

```{r}

#Comparing the lobster sizes across the sites, and putting this information in a table.

size_summary <- size_2017 %>% 
  group_by(Site) %>% 
  summarize("Mean Size" = round(mean(SIZE), 2),
            "Sample Size" = length(Site))

size_summary

size_final <- kable(size_summary, col.names = c("Site", "Mean Carapace Size (mm)", "Sample Size"), align = "c") %>% 
  kable_styling(bootstrap_options = c("striped"))

size_final
  

```

#Part 3 (Bridget)

##These chunks are lumping all the MPV sites together and then comparing 2012 and 2017, and then doing the same thing for non-MPV sites. If we need to do it site by site, this all needs to be changed

#MPA sites: Isla Vista, Naples Reef
#Non-MPA sites:Arroyo Quemado, Carpinteria, Mohawk Reef
```{r}

#For the MPA sites

mpa_size <- lobster_size_tidy %>% 
  filter(SITE == "IVEE" | SITE == "NAPL") %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  select(YEAR, SIZE)
  
  
#Need to test for normality to determine which kind of test to run

mpa_size_hist <- ggplot(mpa_size, aes(x = SIZE)) + 
  geom_histogram(bins = 8) +
  facet_wrap(~YEAR, scale = "free")
  
mpa_size_hist

mpa_size_qq <- ggplot (mpa_size, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~YEAR)

mpa_size_qq

#The data for 2017 looks normally distributed, but the qq plot for 2012 doesn't look linear. We have more than 30 samples for each year though so we can still use a t-test

mpa_2012 <- mpa_size %>% 
  filter(YEAR == "2012") %>% 
  pull(SIZE)

mpa_2017 <- mpa_size %>% 
  filter(YEAR == "2017") %>% 
  pull(SIZE)

#Run an F-test to see which type of t-test we can use
#H0: ratio of variances is equal to 1
#HA: ratio of variances is NOT equal to 1

mpa_ftest <- var.test(mpa_2012, mpa_2017)
mpa_ftest

#Based on result of F-test (p = 0.3346), we retain null hypothesis that variances are equal. We can use a student's t-test, which is more powerful than a Welch's test

#H0 - difference in means is 0
#HA - difference in means is NOT 0

mpa_ttest <- t.test(mpa_2012, mpa_2017, var.equal = TRUE)
mpa_ttest

#With p-value of 0.05576, we retain null hypothesis. There is not a significant difference in mean lobster size in MPAs between 2012 and 2017.

#Calculate effect size

mpa_eff_size <- cohen.d(mpa_2012, mpa_2017)
mpa_eff_size

#There is a small effect size (-0.34)
```

```{r}
#Boxplot for MPA
mpa_size_ordered <- mpa_size %>% 
  mutate(YEAR = factor(YEAR)) %>% 
  group_by(YEAR)

mpa_size_boxplot <- ggplot(mpa_size_ordered, aes(x = YEAR, y = SIZE)) +
  geom_boxplot()

mpa_size_boxplot

#Summary table with mean values

mpa_size_summary <- mpa_size_ordered %>%
  summarize(
    size = mean(SIZE),
    n = length(YEAR)
  )

mpa_size_summary

```

```{r}
#For the non-mpa sites

non_mpa_size <- lobster_size_tidy %>% 
  filter(SITE == "AQUE" | SITE == "MOHK" | SITE == "CARP") %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  select(YEAR, SIZE)
  
  
#Need to test for normality to determine which kind of test to run

non_mpa_size_hist <- ggplot(non_mpa_size, aes(x = SIZE)) + 
  geom_histogram(bins = 8) +
  facet_wrap(~YEAR, scale = "free")
  
non_mpa_size_hist

non_mpa_size_qq <- ggplot (non_mpa_size, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~YEAR)

non_mpa_size_qq

#The data looks normally distributed

non_mpa_2012 <- non_mpa_size %>% 
  filter(YEAR == "2012") %>% 
  pull(SIZE)

non_mpa_2017 <- non_mpa_size %>% 
  filter(YEAR == "2017") %>% 
  pull(SIZE)

#Run an F-test to see which type of t-test we can use
#H0: ratio of variances is equal to 1
#HA: ratio of variances is NOT equal to 1

non_mpa_ftest <- var.test(non_mpa_2012, non_mpa_2017)
non_mpa_ftest

#Based on result of F-test (p = 0.953), we retain null hypothesis that variances are equal. We can use a student's t-test, which is more powerful than a Welch's test

#H0 - difference in means is 0
#HA - difference in means is NOT 0

non_mpa_ttest <- t.test(non_mpa_2012, non_mpa_2017, var.equal = TRUE)
non_mpa_ttest

#With p-value of 0.007, we reject the null hypothesis. There is a significant difference in mean lobster size in non-MPAs between 2012 and 2017.

#Calculate effect size

non_mpa_eff_size <- cohen.d(non_mpa_2012, non_mpa_2017)
non_mpa_eff_size

#There is a small effect size (0.21)
```

```{r}
#Boxplot for Non-MPA
non_mpa_size_ordered <- non_mpa_size %>% 
  mutate(YEAR = factor(YEAR)) %>% 
  group_by(YEAR)

non_mpa_size_boxplot <- ggplot(non_mpa_size_ordered, aes(x = YEAR, y = SIZE)) +
  geom_boxplot()

non_mpa_size_boxplot

#Summary table with mean values

non_mpa_size_summary <- non_mpa_size_ordered %>%
  summarize(
    size = mean(SIZE),
    n = length(YEAR)
  )

non_mpa_size_summary
```

#The following chunks are comparing 2012 and 2017 for each site individually - doesn't seem like these make sense, so probably go with the above analysis

```{r}
#Isla Vista

lobster_sizes_iv <- lobster_size_tidy %>% 
  filter(SITE == "IVEE") %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  select(YEAR, SIZE)

#Create exploratory histogram and qq plot

iv_size_hist <- ggplot(lobster_sizes_iv, aes(x = SIZE)) +
  geom_histogram(bins = 8) +
  facet_wrap(~YEAR)

iv_size_hist
  
iv_size_qq <- ggplot(lobster_sizes_iv, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~YEAR)

iv_size_qq

iv_summary <- lobster_sizes_iv %>% 
  group_by(YEAR) %>% 
  summarize(mean = mean(SIZE), n = length(SIZE))

iv_summary

#QQ plot for 2012 does not look normal, only have 26 observations so can't use CLT
```

```{r}
#Naples

lobster_sizes_napl <- lobster_size_tidy %>% 
  filter(SITE == "NAPL") %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  select(YEAR, SIZE)

#Create exploratory histogram and qq plot

napl_size_hist <- ggplot(lobster_sizes_napl, aes(x = SIZE)) +
  geom_histogram(bins = 8) +
  facet_wrap(~YEAR)

napl_size_hist
  
napl_size_qq <- ggplot(lobster_sizes_napl, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~YEAR)

napl_size_qq

napl_summary <- lobster_sizes_napl %>% 
  group_by(YEAR) %>% 
  summarize(mean = mean(SIZE), n = length(SIZE))

napl_summary
```

#Part 4

