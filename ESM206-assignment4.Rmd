---
title: "ESM206-assignment4"
author: "Claire Madden, Bridget Gibbons, Andrew Paterson"
date: "11/12/2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE}

library(tidyverse)
library(vcdExtra)
library(RColorBrewer)
library(dplyr)
library(car)
library(effsize)
library(kableExtra)

```

```{r, echo=FALSE, message=FALSE}

lobster_size <- read_csv("lobster_size_abundance.csv")
lobster_traps <- read_csv("lobster_traps.csv")

```


```{r}

lobster_size2 <- as.data.frame(lobster_size)
lobster_size_tidy <- expand.dft(lobster_size2, freq = "COUNT")

#If you guys don't want to change the site name here, no problem!
size_tidy <- lobster_size_tidy %>% 
  mutate(Site=
    case_when(
      SITE == "NAPL" ~ "Naples Reef",
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "CARP" ~ "Carpinteria"
    )
  ) %>% 
  select(-SITE)

traps_tidy <- lobster_traps %>% 
    mutate(Site=
    case_when(
      SITE == "NAPL" ~ "Naples Reef",
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "CARP" ~ "Carpinteria"
    )
  ) %>% 
  select(-SITE)


```

#Part 1 (Claire)
```{r}

abundance_summary <- lobster_size %>%
  group_by(SITE, YEAR) %>% 
  summarize(
    count = sum(COUNT))

abundance_column <- ggplot(abundance_summary, aes( x = YEAR, y = count))+
  geom_col()+
  facet_wrap(~SITE)

abundance_column


traps_simple <- lobster_traps %>% 
  filter(SITE == "AQUE" | SITE == "NAPL" | SITE == "MOHK" | SITE == "IVEE" | SITE == "CARP")

traps_summary <- traps_simple %>% 
  group_by(SITE, YEAR) %>% 
  summarize(
    traps = sum(TRAPS))

traps_column <- ggplot(traps_summary, aes( x = YEAR, y = traps))+
  geom_col()+
  facet_wrap(~SITE)

traps_column


abundance_scatter <- ggplot(abundance_summary, aes(x = YEAR, y = count))+
  geom_point()+
  geom_line()+
  facet_wrap(~SITE)

abundance_scatter

traps_scatter <- ggplot(traps_summary, aes(x = YEAR, y = traps))+
  geom_point()+
  geom_line()+
  facet_wrap(~SITE)

traps_scatter

```

```{r}
# my attempt at joining the data before graphing and or getting both graphs for one location on the same plane

abundance_traps <- full_join(abundance_summary, traps_summary)


both_scatter <- ggplot(abundance_traps, aes(x = YEAR))+
  geom_line(aes(y=count, color = "blue"))+
  geom_line(aes(y=traps, color = "red"))+
  facet_wrap(~SITE)+
  theme_light()

both_scatter




```


#Part 2 (Andrew)

```{r}

#Filter for just 2017 results for Part 2, and Exploratory Histogram and QQ Plots

size_2017 <- size_tidy %>% 
  filter(YEAR == "2017") %>%
  select(SIZE, Site)

carapace_hist <- ggplot(size_2017, aes(x = SIZE))+
  geom_histogram(bins = 23, aes(fill = Site))+
  facet_wrap(~Site)

carapace_hist

carapace_qq <- ggplot(size_2017, aes(sample = SIZE))+
  geom_qq()+
  facet_wrap(~Site)

carapace_qq

#The data looks roughly normally distributed, and all sites have a sample size of greater than 30. 

```

```{r}

#Levene's Test for Equal Variances, since we have more than two groups
#H0: Variances are equal
#HA: Variances are not equal

carapace_levene <- leveneTest(SIZE ~ Site, data = size_2017)
carapace_levene

#We reject the null hypothesis of equal variances (p < .001) based on Levene's Test.  However, we can examine the variances of each site to see if the largest is less than four times the smallest variance.  

carapace_variances <- size_2017 %>% 
  group_by(Site) %>% 
  summarize(
    Variance = var(SIZE)
  )

carapace_variances

#The largest variance is well less than four times the smallest variance, so we can assume accept the null hypothesis of equal variances and run an ANOVA.

#H0: Mean carapace sizes are equal at all sites
#HA: Mean carapace sizes vary for lobsters from at least two sites.

carapace_aov <- aov(SIZE ~ Site, data = size_2017)
summary(carapace_aov)

#boxplot for ANOVA in case we want to include this
lobster_anova <- ggplot(size_2017, aes(x = Site, y = SIZE))+
  geom_boxplot()+
  scale_x_discrete()+
  scale_y_discrete()+
  ylab("Size")+
  xlab("Site")

lobster_anova

#With p = .0085, we reject the null, and assume mean carapace length varies between lobsters from at least two sites. At least two populations were taken from populations with different means.

#Post-hoc testing using Tukey's HSD

carapace_ph <- TukeyHSD(carapace_aov)
carapace_ph

#Lobster sizes differed significantly between all sites aside from Naples Reef and Isla Vista. Do we want to run Cohen's d here?  It might get very clunky to convey all of the effect sizes, or maybe we could make a table showing all of the differences and effect sizes?

```

**Figure 1: Mean Lobster Carapace Length at Five LTER Sites in the Santa Barbara Channel** 

```{r}

#Comparing the lobster sizes across the sites, and putting this information in a table.

size_summary <- size_2017 %>% 
  group_by(Site) %>% 
  summarize("Mean Size" = round(mean(SIZE), 2),
            "Sample Size" = length(Site))

size_summary

size_final <- kable(size_summary, col.names = c("Site", "Mean Carapace Size (mm)", "Sample Size"), align = "c") %>% 
  kable_styling(bootstrap_options = c("striped"))

size_final
  

```

